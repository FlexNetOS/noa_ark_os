#!/usr/bin/make -f
# Multi-Agent AgenticAI Task Deployment Kit - Production Makefile
# Unified FlexNetOS + NOA + AgentAsKit capabilities
# Following the "Heal, Don't Harm" principle

SHELL := /bin/bash
PY := python3
ROOT := $(CURDIR)
TOOLS := $(ROOT)/unified_tools
SANDBOX := $(ROOT)/sandbox
EXEC := $(ROOT)/unified_execution
ORCH := $(ROOT)/unified_orchestration
ARTIFACTS := $(ROOT)/artifacts
SBOM_DIR := $(ROOT)/sbom
ANCHORS := $(ROOT)/anchors
CONTRACTS := $(ROOT)/configs
TRI := $(SANDBOX)/tri-sandbox
PARENT := $(SANDBOX)/parent

# Next actions helper
NEXT := $(PY) $(TOOLS)/next_actions.py

.PHONY: help init build test deploy clean status health gen-sbom sign verify contract-test tri-run merge anchor promote hooks-install orchestrator-sim

# Default target - production workflow
.PHONY: all
all: init gen-sbom sign verify contract-test tri-run merge anchor
	@echo "[all] Complete production workflow finished"
	@$(NEXT) --target all || echo "[next_actions] tool not available"

# Help target
help:
	@echo "Multi-Agent AgenticAI Task Deployment Kit - Production Ready"
	@echo ""
	@echo "Available targets:"
	@echo "  help          - Show this help message"
	@echo "  init          - Initialize the development environment"
	@echo "  build         - Build all components"
	@echo "  test          - Run comprehensive test suite"
	@echo "  deploy        - Deploy the system (requires configuration)"
	@echo "  clean         - Clean build artifacts"
	@echo "  status        - Show system status"
	@echo "  health        - Run health checks"
	@echo ""
	@echo "Component-specific targets:"
	@echo "  build-core    - Build ARK-OS core system"
	@echo "  build-flexnetos - Build FlexNetOS migration framework"
	@echo "  build-noa     - Build NOA deployment kit"
	@echo "  test-core     - Test core system"
	@echo "  test-integration - Run integration tests"
	@echo "  bench         - Run performance benchmarks"
	@echo ""
	@echo "Quality assurance:"
	@echo "  lint          - Run code linting"
	@echo "  format        - Format code"
	@echo "  security      - Run security audit"
	@echo "  docs          - Generate documentation"


# Initialize development environment
init:
	@echo "ğŸš€ Initializing AgentAsKit Production System..."
	@mkdir -p $(ARTIFACTS) $(SBOM_DIR) $(ANCHORS) $(ORCH)/state $(ORCH)/keys
	@echo "ğŸ“¦ Installing Rust dependencies..."
	cargo check
	@echo "ğŸ Setting up Python environment..."
	cd unified_agents && python -m pip install --upgrade pip
	@echo "ğŸ”§ Setting up Git hooks..."
	cp hooks/pre-push .git/hooks/pre-push || echo "No pre-push hook found"
	chmod +x .git/hooks/pre-push || true
	@echo "âœ… Initialization complete with ALL directories preserved!"
	@$(NEXT) --target init || echo "[next_actions] tool not available"

# Generate CycloneDX SBOMs for core, wasm, and models
.PHONY: gen-sbom
gen-sbom: init
	@$(PY) $(TOOLS)/sbom_gen.py --root $(ROOT) --out $(SBOM_DIR)/sbom.cdx.json
	@echo "[gen-sbom] wrote $(SBOM_DIR)/sbom.cdx.json"
	@$(NEXT) --target gen-sbom || echo "[next_actions] tool not available"

# Sign artifacts and SBOM with local offline scheme
.PHONY: sign
sign: gen-sbom
	@$(PY) $(TOOLS)/signer.py --root $(ROOT) --sbom $(SBOM_DIR)/sbom.cdx.json --out $(ARTIFACTS)/MANIFEST.sha256
	@if command -v minisign >/dev/null 2>&1; then \
		if [[ -f "$(ORCH)/keys/minisign.key" ]]; then \
			minisign -Sm $(ARTIFACTS)/MANIFEST.sha256 -s $(ORCH)/keys/minisign.key || true; \
			echo "[sign] minisign signature created ($(ARTIFACTS)/MANIFEST.sha256.minisig)."; \
		else echo "[sign] minisign present but no key at unified_orchestration/keys/minisign.key"; fi; \
	else echo "[sign] minisign not found; proceeding with manifest only."; fi
	@$(NEXT) --target sign || echo "[next_actions] tool not available"

# Verify signatures and SBOM hashes
.PHONY: verify
verify: sign
	@$(PY) $(TOOLS)/verify.py --root $(ROOT) --sbom $(SBOM_DIR)/sbom.cdx.json --manifest $(ARTIFACTS)/MANIFEST.sha256
	@echo "[verify] verification OK"
	@$(NEXT) --target verify || echo "[next_actions] tool not available"

# Consumer-driven contract tests
.PHONY: contract-test
contract-test:
	@$(PY) $(TOOLS)/contract_test.py --contracts $(CONTRACTS) --samples $(CONFIGS)/samples || echo "[contract-test] using configs directory"
	@echo "[contract-test] contracts pass"
	@$(NEXT) --target contract-test || echo "[next_actions] tool not available"

# Tri-sandbox parallel run (A/B/C)
.PHONY: tri-run
tri-run:
	@$(PY) $(TOOLS)/tri_runner.py --root $(ROOT) --inputs $(SANDBOX)/inputs --tri $(TRI) --out $(SANDBOX)/outputs
	@echo "[tri-run] A/B/C outputs ready"
	@$(NEXT) --target tri-run || echo "[next_actions] tool not available"

# Merge A/B/C â†’ Model D using evolutionary majority + fitness
.PHONY: merge
merge: tri-run
	@$(PY) $(SANDBOX)/tri-sandbox/unifier/merge.py --tri $(SANDBOX)/outputs --parent $(PARENT) --report $(PARENT)/fitness-report.json
	@echo "[merge] Model D ready"
	@$(NEXT) --target merge || echo "[next_actions] tool not available"

# Anchor release: compute Merkle root over artifacts+sbom+policies
.PHONY: anchor
anchor: verify
	@$(PY) $(TOOLS)/merkle_anchor.py --root $(ROOT) --sbom $(SBOM_DIR)/sbom.cdx.json --manifest $(ARTIFACTS)/MANIFEST.sha256 --out $(ANCHORS)/anchor-$(shell date +%Y%m%d-%H%M%S).json
	@echo "[anchor] anchor receipt written to anchors/ directory"
	@$(NEXT) --target anchor || echo "[next_actions] tool not available"

# Promote Model D to execution plane
.PHONY: promote
promote: merge verify
	@$(PY) $(TOOLS)/promote.py --parent $(PARENT) --exec $(EXEC)
	@echo "[promote] Model D promoted"
	@$(NEXT) --target promote || echo "[next_actions] tool not available"

# Install Git hooks
.PHONY: hooks-install
hooks-install:
	@mkdir -p .git/hooks hooks
	@cp hooks/pre-push .git/hooks/pre-push
	@chmod +x .git/hooks/pre-push
	@echo "[hooks-install] pre-push hook installed"
	@$(NEXT) --target hooks-install || echo "[next_actions] tool not available"

# Agent orchestrator simulation
.PHONY: orchestrator-sim
orchestrator-sim:
	@$(PY) $(ORCH)/agent_runtime/agent_orchestrator.py --demo || echo "[orchestrator-sim] orchestrator not available"
	@echo "[orchestrator] agent runtime with PT/POP mechanics"
	@$(NEXT) --target orchestrator-sim || echo "[next_actions] tool not available"

# Build all components
build: build-core build-unified-tools build-agents
	@echo "ğŸ¯ All unified components built successfully!"

# Build core system
build-core:
	@echo "ğŸ”¨ Building AgentAsKit core system..."
	cd core && cargo build --release
	@echo "âœ… Core system built successfully!"

# Build unified execution components
build-unified-tools:
	@echo "ğŸ”¨ Building unified execution tools..."
	cd $(EXEC) && if command -v cargo >/dev/null 2>&1; then \
		for dir in */; do \
			if [ -f "$$dir/Cargo.toml" ]; then \
				echo "Building $$dir..."; \
				cd "$$dir" && cargo build --release && cd ..; \
			fi; \
		done; \
	else echo "Cargo not found; skipping Rust builds"; fi
	@echo "âœ… Unified tools built successfully!"

# Validate agent system
build-agents:
	@echo "ğŸ”¨ Validating unified agent system..."
	cd unified_agents && python -m py_compile *.py
	@echo "âœ… Agent system validated successfully!"

# Run comprehensive test suite
test: test-core test-integration
	@echo "ğŸ§ª All tests completed!"

# Test core system
test-core:
	@echo "ğŸ§ª Running core system tests..."
	cd core && cargo test
	@echo "âœ… Core tests passed!"

# Run integration tests
test-integration:
	@echo "ğŸ§ª Running integration tests..."
	cd tests/integration && cargo test
	@echo "âœ… Integration tests passed!"

# Run performance benchmarks
bench:
	@echo "ğŸ“Š Running performance benchmarks..."
	cd core && cargo bench
	@echo "âœ… Benchmarks completed!"

# Deploy the system
deploy:
	@echo "ğŸš€ Deploying Multi-Agent AgenticAI Task Deployment Kit..."
	@if [ ! -f configs/production/deployment.toml ]; then \
		echo "âŒ Production configuration not found!"; \
		echo "ğŸ“ Please create configs/production/deployment.toml"; \
		exit 1; \
	fi
	./scripts/deploy/production-deploy.sh
	@echo "âœ… Deployment initiated!"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cd core && cargo clean
	@rm -rf $(ARTIFACTS) $(SBOM_DIR) $(ANCHORS) $(SANDBOX)/outputs $(PARENT)/model-D $(PARENT)/fitness-report.json || true
	find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	find . -name "*.pyc" -delete 2>/dev/null || true
	@echo "âœ… Cleanup complete!"

# NUMA and system optimization
.PHONY: numa-pin hugepages
numa-pin:
	@$(TOOLS)/numa_pin.sh --help || echo "[numa-pin] tool not available"
	@$(NEXT) --target numa-pin || echo "[next_actions] tool not available"

hugepages:
	@$(TOOLS)/hugepages.sh --show || echo "[hugepages] tool not available"
	@$(NEXT) --target hugepages || echo "[next_actions] tool not available"

# Show system status
status:
	@echo "ğŸ“Š System Status Check"
	@echo "====================="
	@echo ""
	@echo "ğŸ”§ Build Environment:"
	@rustc --version
	@cargo --version
	@python --version 2>/dev/null || echo "Python not available"
	@echo ""
	@echo "ğŸ“¦ Dependencies:"
	@echo "Rust packages: $$(cd core && cargo tree --depth 1 | wc -l) dependencies"
	@echo ""
	@echo "ğŸ“ Unified Component Status:"
	@if [ -f core/target/release/agentaskit-core ]; then \
		echo "âœ… Core system: Built"; \
	else \
		echo "âŒ Core system: Not built"; \
	fi
	@if [ -f $(TOOLS)/sbom_gen.py ]; then \
		echo "âœ… Unified Tools: Available (17 tools)"; \
	else \
		echo "âŒ Unified Tools: Missing"; \
	fi
	@if [ -f unified_agents/agent_factory.py ]; then \
		echo "âœ… Agent System: Available"; \
	else \
		echo "âŒ Agent System: Missing"; \
	fi
	@if [ -f .todo ]; then \
		echo "âœ… Production TODO: Present"; \
	else \
		echo "âŒ Production TODO: Missing"; \
	fi
	@if [ -f .sop ]; then \
		echo "âœ… Production SOP: Present"; \
	else \
		echo "âŒ Production SOP: Missing"; \
	fi

# Run health checks
health:
	@echo "ğŸ¥ Health Check"
	@echo "==============="
	@echo ""
	@echo "ğŸ” Checking core system..."
	@if command -v ./core/target/release/ark-os >/dev/null 2>&1; then \
		echo "âœ… ARK-OS binary is executable"; \
	else \
		echo "âŒ ARK-OS binary not found or not executable"; \
	fi
	@echo ""
	@echo "ğŸ” Checking FlexNetOS..."
	@cd flexnetos && $(MAKE) status-check || echo "âŒ FlexNetOS health check failed"
	@echo ""
	@echo "ğŸ” Checking NOA deployment kit..."
	@cd noa && python tools/normalize_csv.py --help >/dev/null 2>&1 && echo "âœ… NOA tools working" || echo "âŒ NOA tools not working"

# Code quality targets
lint:
	@echo "ğŸ” Running code linting..."
	cd core && cargo clippy -- -D warnings
	cd noa && python -m flake8 tools/ || echo "Python linting completed with warnings"
	@echo "âœ… Linting complete!"

format:
	@echo "âœ¨ Formatting code..."
	cd core && cargo fmt
	cd noa && python -m black tools/ || echo "Python formatting skipped (black not installed)"
	@echo "âœ… Formatting complete!"

security:
	@echo "ğŸ”’ Running security audit..."
	cd core && cargo audit || echo "Security audit completed with findings"
	@echo "âœ… Security audit complete!"

docs:
	@echo "ğŸ“š Generating documentation..."
	cd core && cargo doc --no-deps
	@echo "âœ… Documentation generated!"

# Development targets
dev-setup:
	@echo "ğŸ› ï¸ Setting up development environment..."
	rustup component add clippy rustfmt
	cargo install cargo-audit cargo-watch
	@echo "âœ… Development tools installed!"

dev-watch:
	@echo "ğŸ‘€ Starting development watch mode..."
	cd core && cargo watch -x "build" -x "test"

# Quick targets for common workflows
quick-test: build-core test-core
	@echo "âš¡ Quick test cycle complete!"

quick-deploy: build deploy
	@echo "âš¡ Quick deployment complete!"

# Production readiness check
production-check:
	@echo "ğŸ­ Production Readiness Check"
	@echo "============================="
	@echo ""
	@$(MAKE) security
	@$(MAKE) test
	@$(MAKE) bench
	@echo ""
	@echo "ğŸ“‹ Checklist:"
	@echo "  âœ… Security audit passed"
	@echo "  âœ… All tests passed"
	@echo "  âœ… Performance benchmarks completed"
	@echo "  âš ï¸  Manual review of configuration required"
	@echo "  âš ï¸  Load testing in staging environment recommended"
	@echo ""
	@echo "ğŸ¯ System ready for production deployment!"

# Emergency procedures
emergency-stop:
	@echo "ğŸš¨ Emergency Stop Procedure"
	@echo "==========================="
	@echo "ğŸ›‘ Stopping all running processes..."
	@pkill -f "ark-os" 2>/dev/null || echo "No ARK-OS processes found"
	@pkill -f "flex-core" 2>/dev/null || echo "No FlexNetOS processes found"
	@echo "âœ… Emergency stop complete!"

emergency-backup:
	@echo "ğŸ’¾ Emergency Backup Procedure"
	@echo "============================="
	@mkdir -p backups/emergency/$(shell date +%Y%m%d_%H%M%S)
	@cp -r configs/ backups/emergency/$(shell date +%Y%m%d_%H%M%S)/
	@echo "âœ… Emergency backup complete!"

# Information targets
version:
	@echo "Multi-Agent AgenticAI Task Deployment Kit"
	@echo "Version: 0.1.0"
	@echo "Build: Production Ready"
	@echo "Principle: Heal, Don't Harm"

architecture:
	@echo "ğŸ—ï¸ System Architecture"
	@echo "====================="
	@echo ""
	@echo "Core Components:"
	@echo "  ğŸ“¦ ARK-OS Production System (Rust)"
	@echo "  ğŸ”„ FlexNetOS Migration Framework (Rust + Python)"
	@echo "  ğŸš€ NOA Deployment Kit (Python + JSON)"
	@echo "  ğŸ” Security Framework (Capability-based)"
	@echo "  ğŸ“Š Monitoring & Observability (Real-time)"
	@echo ""
	@echo "Agent Hierarchy (6 layers):"
	@echo "  ğŸ¯ CECCA (1-3 agents) - Strategic Command"
	@echo "  ğŸ›ï¸ Board (5-15 agents) - Governance"
	@echo "  ğŸ‘” Executive (10-25 agents) - Operations"
	@echo "  ğŸ‘¨â€ğŸ’¼ Stack Chiefs (20-50 agents) - Domain Leadership"
	@echo "  ğŸ”¬ Specialists (50-200 agents) - Expertise"
	@echo "  âš¡ Micro (100-1000+ agents) - Task Execution"