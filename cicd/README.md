# CI/CD Pipeline - Continuous Delivery Focus

Maximum focus on Continuous Delivery (CD) for NOA ARK OS.

## Philosophy

**Continuous Delivery First**: Every commit is potentially deployable. CI validates, CD delivers.

## Autonomous Release Controls

- **Trust-gated auto merges** – `cicd/src/trigger.rs` now evaluates historical trust metrics from
  `audit/ledger.jsonl` before executing a git merge preview. Passing merges archive their diff under
  `audit/merges/` and append an approval entry to the ledger.
- **Scheduled rollback drills** – _Planned:_ automated exercises of git worktree rollbacks, with outcomes to be recorded in both `audit/rollbacks/` and the ledger. (Implementation pending)
- **Signed audit bundles** – `make publish-audit` captures an SBOM, trust summary, and release
  metadata into `audit/bundle-*` directories and validates the output through
  `audit/verify.sh` / `audit/verify.py`.

## Architecture

```
cicd/
├── ci/                # Continuous Integration
│   ├── triggers/      # Build triggers
│   ├── validation/    # Code validation
│   ├── testing/       # Test execution
│   └── artifacts/     # Build artifacts
├── cd/                # Continuous Delivery (PRIMARY FOCUS)
│   ├── deployment/    # Automated deployment
│   ├── rollout/       # Progressive rollout
│   ├── monitoring/    # Deployment monitoring
│   ├── rollback/      # Automatic rollback
│   └── promotion/     # Environment promotion
├── pipelines/         # Pipeline definitions
├── environments/      # Target environments
└── automation/        # Full automation scripts
```

## Agent-Managed Pipelines

- `cicd/pipelines/doc-refresh.yaml` routes documentation refresh through planner and verifier
  checkpoints. Self-healing executes `tools/maintenance/workspace_optimization.sh` and
  `services/gateway/self_heal.py` before content changes are applied.
- `cicd/pipelines/agent-self-heal.yaml` defines the end-to-end self-healing pipeline used by
  deployment workflows. Each stage specifies `agent_role` bindings so the workflow engine can
  resolve the correct agent implementation from `agents/data/agent_roles.json`.
- Evidence generated by these pipelines is appended automatically to
  `docs/reports/AGENT_DEPLOYMENT_OUTCOMES.md` for audit.

## CI Pipeline (Fast & Light)

### Stage 1: Validation (< 2 minutes)
- Code formatting check
- Linting
- Security scan (fast)
- Dependency check

### Stage 2: Build (< 5 minutes)
- Compile all languages (Rust, Go, Python, C#)
- Run unit tests (parallel)
- Generate artifacts
- Create container images

### Stage 3: Test (< 10 minutes)
- Integration tests
- API tests
- Performance tests (quick)
- Smoke tests

**Total CI Time: < 15 minutes**

## CD Pipeline (PRIMARY FOCUS)

### Stage 1: Pre-Deploy
- Artifact verification
- Environment health check
- Dependency validation
- Backup current state

### Stage 2: Deploy
- Blue-green deployment
- Canary releases
- Rolling updates
- Feature flags

### Stage 3: Verify
- Health checks
- Smoke tests in production
- Performance monitoring
- User acceptance signals

### Stage 4: Promote/Rollback
- Auto-promote if healthy
- Auto-rollback if issues
- Traffic shifting
- Gradual rollout

## Deployment Strategies

### 1. Blue-Green Deployment
```
Blue (Current) ←→ Green (New)
     ↓
   Switch traffic when ready
```

### 2. Canary Release
```
Production: 95% old, 5% new
           ↓
Monitor canary performance
           ↓
Gradually increase new traffic
           ↓
100% new when validated
```

### 3. Rolling Update
```
Update 1 instance → Validate → Update next
```

### 4. Feature Flags
```
Deploy code (disabled) → Enable for % users → Monitor → Full rollout
```

## Automation Levels

### Level 1: Automated Build
- Triggered on commit
- Build and test
- Generate artifacts

### Level 2: Automated Deploy to Staging
- Deploy successful builds
- Run integration tests
- Generate reports

### Level 3: Automated Deploy to Production (TARGET)
- Deploy to production automatically
- Monitor health metrics
- Rollback if needed
- Zero human intervention

## Key Metrics (CD Focus)

### Deployment Frequency
- Target: Multiple deployments per day
- Track: Deployments per hour/day/week

### Lead Time
- Target: < 1 hour from commit to production
- Track: Time from commit to deployment

### Change Failure Rate
- Target: < 5%
- Track: Failed deployments / Total deployments

### Mean Time to Recovery (MTTR)
- Target: < 5 minutes
- Track: Time from failure to recovery

## Pipeline as Code

```yaml
pipeline:
  name: "noa-ark-os-cd"
  
  ci:
    - validate:
        parallel: true
        jobs:
          - lint
          - format-check
          - security-scan
    
    - build:
        parallel: true
        jobs:
          - build-rust
          - build-go
          - build-python
          - build-dotnet
    
    - test:
        parallel: true
        jobs:
          - unit-tests
          - integration-tests
          - api-tests
  
  cd:
    - deploy-staging:
        strategy: blue-green
        auto: true
        
    - verify-staging:
        health-checks: true
        smoke-tests: true
        performance-tests: true
    
    - deploy-production:
        strategy: canary
        auto: true
        canary-percentage: 5
        promotion-delay: 5m
        
    - monitor:
        duration: 30m
        rollback-on-error: true
        
    - promote:
        auto: true
        condition: all-healthy
```

## Rollback Strategy

### Automatic Rollback Triggers
- Error rate > 5%
- Response time > 2x baseline
- Health check failures
- Critical errors detected
- User complaints > threshold

### Rollback Process
1. Detect issue (< 1 minute)
2. Trigger rollback (immediate)
3. Switch traffic to previous version (< 30 seconds)
4. Verify rollback success (< 1 minute)
5. Alert team (immediate)
6. Post-mortem analysis

## Monitoring Integration

Real-time metrics:
- Deployment status
- Health checks
- Error rates
- Performance metrics
- User experience metrics
- Resource utilization

## Environment Strategy

```
Developer Sandbox → Integration (D) → Staging → Production
      ↓                  ↓              ↓           ↓
   Local test      Full validation  Pre-prod   Live users
```

## Security in CD

- Automated security scanning
- Secrets management
- Access control
- Audit logging
- Compliance checks

## Feature Flags System

```rust
if feature_enabled("new_ui") {
    // New UI code
} else {
    // Old UI code
}
```

Benefits:
- Deploy anytime, release separately
- A/B testing
- Gradual rollout
- Quick disable if issues

## Self-Contained CD

All CD tools run on NOA ARK OS:
- No external CI/CD services
- Self-hosted pipelines
- Internal artifact storage
- Built-in monitoring

## Zero-Downtime Deployments

Every deployment is zero-downtime:
- Health checks before traffic switch
- Gradual traffic migration
- Instant rollback capability
- Connection draining
