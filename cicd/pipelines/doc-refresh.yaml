name: docs-refresh
on:
  merge:
    branches:
      - main
    paths:
      - 'docs/**'
      - '.workspace/sop/**'
      - 'workflow/**'
      - 'agents/src/implementations/documentation/**'

variables:
  DOC_AGENT_BIN: 'cargo run -p noa_agents --bin documentation_sync'
  AGENT_PLANNER_ROLE: 'planner'
  AGENT_VERIFIER_ROLE: 'verifier'

agent_roles:
  planner: PlanAgent
  verifier: ReviewAgent
  operator: OperationsBoardAgent

agent_checkpoints:
  - name: planner-sanity
    role: planner
    verifies: build_output/planner_review.json
    description: 'Planner agent reviews workspace healing output before docs refresh.'
  - name: verifier-gate
    role: verifier
    verifies: docs/reports/AGENT_DEPLOYMENT_OUTCOMES.md
    description: 'Verifier agent confirms deployment evidence recorded.'

stages:
  - prepare
  - validate
  - docs
  - verify

jobs:
  agent-self-heal:
    stage: prepare
    script:
      - mkdir -p build_output
      - tools/maintenance/workspace_optimization.sh --mode=agent || tools/maintenance/workspace_optimization.sh
      - python services/gateway/self_heal.py --output build_output/gateway-self-heal.json
      - cp build_output/gateway-self-heal.json build_output/planner_review.json
    artifacts:
      paths:
        - build_output/gateway-self-heal.json
        - build_output/planner_review.json
    checkpoints:
      required:
        - role: ${AGENT_PLANNER_ROLE}
          artifact: build_output/planner_review.json
          summary: 'Planner validated the self-heal output.'

  validate:
    stage: validate
    script:
      - cargo fmt --check
      - cargo test -p noa_agents writes_expected_artifacts

  doc-refresh:
    stage: docs
    needs:
      - validate
      - agent-self-heal
    script:
      - mkdir -p build_output
      - echo "Generating diff summary"
      - git diff --name-status HEAD^ HEAD > build_output/doc_diff.txt
      - echo "Triggering documentation pipeline"
      - cicd trigger-doc-pipeline \
          --commit "$CI_COMMIT_SHA" \
          --diff-summary "$(head -n 20 build_output/doc_diff.txt)" \
          --approvals "${DOC_APPROVALS_REQUIRED[*]}"
      - echo "Running documentation agent"
      - ${DOC_AGENT_BIN} --pipeline-output build_output/doc_diff.txt
    artifacts:
      paths:
        - build_output/doc_diff.txt
    checkpoints:
      required:
        - role: ${AGENT_VERIFIER_ROLE}
          artifact: docs/reports/AGENT_DEPLOYMENT_OUTCOMES.md
          summary: 'Verifier captured deployment evidence entry.'

  verify:
    stage: verify
    needs:
      - doc-refresh
    script:
      - echo "Verifying documentation updates"
      - test -f docs/wiki/index.md
      - test -f docs/runbook/index.md
      - echo "Documentation artifacts verified"
