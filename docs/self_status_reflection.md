# Self Status Reflection Surface

The `/api/v1/self/status` endpoint consolidates observability signals needed by
self-healing automations. It is implemented by the unified gateway and backed
by existing telemetry artefacts generated by the workflow instrumentation,
drift detector, and gateway router.

## Endpoint

```
GET /api/v1/self/status
```

**Response fields**

| Field | Description |
| --- | --- |
| `generated_at` | ISO-8601 timestamp when the snapshot was produced |
| `drift` | Drift alerts from `cicd/ml/reports/drift_report.jsonl` |
| `hot_paths` | High-volume workflows derived from `storage/db/analytics/goal_kpis.json` |
| `budget_offenders` | Goals breaching latency or success-rate budgets |
| `telemetry` | Aggregated metrics including gateway request counts and workflow success rate |

## Safeguards

* Capability gating is enforced via the scorekeeper integration inside
  `SelfDebuggingRepairSystem`. Automated repairs are blocked when the capability
  score falls below the configured threshold (default: `0.70`).
* Every repair attempt writes an audit entry to
  `storage/logs/self_repair_audit.jsonl`, capturing trust signals and outcomes.
* Snapshot directories under `storage/snapshots/self_repair/` are created before
  executing a plan so that rollbacks can restore previous state quickly.

## Periodic Planning

The scheduler located at `workflow/cron/self_repair_scheduler.py` issues
improvement plans every 15 minutes by default. Plans are stored in
`storage/self_repair/plans/plan-<timestamp>.json` and include actionable
recommendations derived from the self-status telemetry. The scheduler then calls
the self-repair agent with the plan details.

To run a single planning cycle:

```python
from workflow.cron.self_repair_scheduler import PeriodicPlanner
import asyncio

planner = PeriodicPlanner()
asyncio.run(planner.run_once())
```

## Telemetry Inputs

1. **Drift reports** – Produced by the drift detection scripts under
   `cicd/ml/scripts/`; consumed as JSON lines.
2. **Goal metrics** – Persisted by the workflow instrumentation in
   `storage/db/analytics/goal_kpis.json`.
3. **Gateway metrics** – Exported from `storage/telemetry/gateway_metrics.json`
   by the gateway telemetry sink.

These artifacts already exist in the repository and the aggregator only reads
them, keeping the new surfaces offline-first and auditable.

## Instrumentation Artefacts

Self-healing surfaces depend on the mirrored instrumentation assets documented
in the storage layer. Ensure the following exist before invoking automation:

- [Auto-fix action snapshots](../storage/db/auto_fix/README.md) for repair plans
  and policy decisions.
- [Budget guardian manifests](../storage/db/budget_guardian/README.md) capturing
  token/latency enforcement.
- [Pipeline log mirror schema](../storage/db/pipelines/README.md) describing the
  signed ledgers that power receipts and analytics.

All three derive from the `.workspace/indexes/` sources described in
[`storage/db/README.md`](../storage/db/README.md); their presence is required for
accurate goal and budget reporting on this endpoint.

