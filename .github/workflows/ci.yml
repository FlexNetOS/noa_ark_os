name: CI

on:
  push:
    branches:
      - main
      - "release/**"
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      OFFLINE_FIRST: "true"
      ONLINE_GITHUB_MODE: "false"
      AI_PROVIDER: "llama.cpp"
      LLAMA_CPP_ENDPOINT: "http://127.0.0.1:8080/v1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Require local pipeline evidence
        run: python tools/ci/require_local_pipeline.py --require-logs
      - name: Validate roadmap task index
        run: python tools/task_index_validator.py

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.11.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: actions/cache@v4.3.0
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: 
          # An explicit key for restoring and saving the cache
          key: 
          # An ordered multiline string listing the prefix-matched keys, that are used for restoring stale cache if no cache hit occurred for key. Note `cache-hit` returns false in this case.
          restore-keys: # optional
          # The chunk size used to split up large files during upload, in bytes
          upload-chunk-size: # optional
          # An optional boolean when enabled, allows windows runners to save or restore caches that can be restored or saved respectively on other platforms
          enableCrossOsArchive: # optional, default is false
          # Fail the workflow if cache entry is not found
          fail-on-cache-miss: # optional, default is false
          # Check if a cache entry exists for the given input(s) (key, restore-keys) without downloading the cache
          lookup-only: # optional, default is false
          # Run the post step to save the cache even if another step before fails
          save-always: # optional, default is false

      - name: Show tool versions
        run: |
          node --version
          pnpm --version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Pre-Commit Archive Snapshot
        env:
          BASE_REF: ${{ github.base_ref || 'origin/main' }}
        run: bash tools/ci/pre_commit_archive.sh
      - name: Fast Health Gate (Early Fail)
        env:
          HEALTH_MAX_UPTIME_SECONDS: 10
          CI_FAST_HEALTH_TIMEOUT_SECONDS: 120
          CI_FAST_HEALTH_PROBE_DELAY_SECONDS: 6
        run: make ci-fast-health
      - name: Validate Readiness Schema
        run: |
          pip install jsonschema
          python tools/ci/validate_readiness.py
      - name: Negative Health (Stale Uptime) Check
        env:
          HEALTH_MAX_UPTIME_SECONDS: 1
          CI_FAST_HEALTH_TIMEOUT_SECONDS: 60
          CI_FAST_HEALTH_PROBE_DELAY_SECONDS: 4
        run: make health-negative || echo "Expected failure for stale process scenario (non-zero acceptable)"
      - name: Verify provider instruction pointers
        run: pnpm exec tsx tools/ci/verify_provider_pointers.ts

      - name: Guardrail: Deletion Lock + Evidence Ledger
        shell: bash
        run: |
          set -euo pipefail
          base=origin/${{ github.base_ref || 'main' }}
          git diff --name-status "$base"... | tee diff.txt
          if grep -E '^(D|R[0-9]+)\s' diff.txt >/dev/null; then
            changed=$(git diff --name-only "$base"...)
            echo "$changed" | grep -q '^archive/' || { echo "Deletion/rename found but no archive/ artifacts present." >&2; exit 1; }
            echo "$changed" | grep -q '^docs/verification/' || { echo "Deletion/rename found but no evidence ledger update under docs/verification/." >&2; exit 1; }
          fi

      - name: Guardrail: Duplicate Fence (SHA-256 twins)
        shell: bash
        run: |
          set -euo pipefail
          python3 - << 'PY'
import hashlib, os, sys, subprocess
ALLOW_PREFIXES = ("archive/","out/",".git/",".next/","target/","node_modules/","dist/","build/")
base = os.environ.get('GITHUB_BASE_REF') or 'main'
changed = subprocess.run(["bash","-lc",f"git diff --name-only origin/{base}..."], capture_output=True, text=True).stdout.split()
seen = {}
violations = []
for p in changed:
    if any(p.startswith(a) for a in ALLOW_PREFIXES):
        continue
    if not os.path.isfile(p):
        continue
    with open(p,'rb') as f:
        h = hashlib.sha256(f.read()).hexdigest()
    if h in seen and seen[h] != p:
        violations.append((p, seen[h], h))
    else:
        seen[h] = p
if violations:
    print('Duplicate content detected:', file=sys.stderr)
    for a,b,h in violations:
        print(f"  {a} == {b} ({h})", file=sys.stderr)
    sys.exit(1)
PY

      - name: Guardrail: Report Fence (docs/ only for new .md)
        shell: bash
        run: |
          set -euo pipefail
          base=origin/${{ github.base_ref || 'main' }}
          new_md=$(git diff --name-status "$base"... | awk '$1=="A" && $2 ~ /\.(md|MD)$/ {print $2}')
          bad=0
          for f in $new_md; do
            if echo "$f" | grep -qE '^docs/'; then :; else
              echo "New markdown outside docs/: $f" >&2; bad=1
            fi
          done
          exit $bad

      - name: Guardrail: Change Budget
        shell: bash
        run: |
          set -euo pipefail
          base=origin/${{ github.base_ref || 'main' }}
          files=$(git diff --name-only "$base"... | wc -l)
          adds=$(git diff --numstat "$base"... | awk '{sum+=$1} END{print sum+0}')
          echo "Files: $files, Adds: $adds"
          test $files -le 40   || (echo "Too many files changed" && exit 1)
          test $adds  -le 1200 || (echo "Too many lines added" && exit 1)
          disallowed=$(git diff --name-only "$base"... | grep -Ev '^(crc/|server/|ui/|docs/|.github/)') || true
          if [ -n "$disallowed" ]; then
            echo "Disallowed paths:\n$disallowed" >&2
            exit 1
          fi

      - name: Enforce provider pointer stubs (exact content)
        shell: bash
        run: |
          set -euo pipefail
          expect_copilot=$'# Defer to AGENT.md\nUse AGENT.md at repo root as the sole policy and instruction source. Do not duplicate logic here.'
          expect_claude=$'This file intentionally contains no instructions. All policies and execution rules are defined in AGENT.md.'
          expect_pointer=$'Provider/agent instruction policy lives in AGENT.md. Do not place instructions elsewhere.'
          diff -u <(printf "%s\n" "$expect_copilot") .copilot
          diff -u <(printf "%s\n" "$expect_claude") CLAUDE.md
          diff -u <(printf "%s\n" "$expect_pointer") .github/AGENT_POINTER.txt

      - name: Enforce single TS router entrypoint
        shell: bash
        run: |
          set -euo pipefail
          test -f server/ai/router.ts || (echo "server/ai/router.ts missing" >&2; exit 1)
          others=$(git ls-files | grep -E '/router\.ts$' | grep -v '^server/ai/router.ts$' || true)
          if [ -n "$others" ]; then
            echo "Found additional router.ts files:\n$others" >&2
            exit 1
          fi

      - name: Verify archival artifacts
        if: github.event_name != 'pull_request' || !contains(github.event.pull_request.labels.*.name, 'ci-allow-archive-skip')
        env:
          BASE_REF: ${{ github.event.pull_request.base.sha || github.event.before || 'origin/main' }}
        run: pnpm exec tsx tools/ci/verify_archival.ts

      - name: Check duplicate content
        if: ${{ !contains(github.event.pull_request.labels.*.name, 'ci-allow-duplicate-content') }}
        run: pnpm exec tsx tools/ci/check_duplicate_content.ts
      - name: Build
        run: pnpm build

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Enforce single AI router entrypoint
        run: pnpm exec tsx tools/ci/check_router_singleton.ts

      - name: Test
        run: pnpm test
      - name: Agent Automated Review
        run: |
          echo "=== Automated Agent Review (semantic scan for TODO/FIXME) ==="
          cargo run -p noa_tools_agent --bin agent-tools Semantic --query "TODO" --root . | head -n 50 || true
          echo "=== Health Payload ===" && cat logs/readiness.json || echo "No readiness artifact"

      - name: Enforce Conventional Commits
        run: pnpm exec tsx tools/commit_copilot/cli.ts enforce
      - name: Verify Commit Metadata
        run: bash tools/ci/verify_commit_metadata.sh

      - name: Validate Archive Ledger Schema
        run: |
          pip install jsonschema
          python tools/ci/validate_archive_ledger.py

      - name: Export roadmap
        run: pnpm export:roadmap

      - name: Upload roadmap artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pm-roadmap-build-kits
          path: build_kits/pm_roadmap.*

  validation:
    name: Cross-OS validation
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.11.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Show tool versions
        run: |
          node --version
          pnpm --version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Test
        run: pnpm test
