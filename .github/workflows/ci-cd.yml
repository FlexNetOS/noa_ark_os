name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  RUST_VERSION: 1.70.0
  PYTHON_VERSION: 3.9

jobs:
  # Lint and Format Checks
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy
          override: true
      
      - name: Python Linting
        run: |
          pip install flake8 black pylint
          # MicroAgentStack
          cd repos/MicroAgentStack
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          black --check .
          cd ../..
          
      - name: Rust Linting
        run: |
          # agentaskit
          cd repos/agentaskit
          cargo fmt -- --check
          cargo clippy -- -D warnings
          cd ../..
          
          # deflex-ai-os
          cd repos/deflex-ai-os
          cargo fmt -- --check
          cargo clippy -- -D warnings
          cd ../..

  # Python Component Tests
  test-python:
    name: Test Python Components
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [MicroAgentStack, deflexnet-app, ark-os-noa]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          cd repos/${{ matrix.component }}
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov
      
      - name: Run Tests
        run: |
          cd repos/${{ matrix.component }}
          if [ -d tests ]; then
            pytest tests/ -v --cov=. --cov-report=xml
          else
            echo "No tests directory found, skipping"
          fi
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./repos/${{ matrix.component }}/coverage.xml
          flags: ${{ matrix.component }}
          name: ${{ matrix.component }}-coverage

  # Rust Component Tests
  test-rust:
    name: Test Rust Components
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [agentaskit, deflex-ai-os]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          override: true
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            repos/${{ matrix.component }}/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Tests
        run: |
          cd repos/${{ matrix.component }}
          cargo test --verbose
          cargo test --release --verbose
      
      - name: Run Benchmarks
        run: |
          cd repos/${{ matrix.component }}
          if [ -d benches ]; then
            cargo bench --no-run
          fi

  # Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Python Security Scan
        run: |
          pip install safety bandit
          find repos -name requirements.txt -exec safety check -r {} \;
          find repos -name "*.py" -exec bandit -r {} \;
      
      - name: Rust Security Scan
        uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # Docker Build and Push
  docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test-python, test-rust]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        component: [MicroAgentStack, ark-os-noa, deflex-ai-os]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: ./repos/${{ matrix.component }}
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/${{ matrix.component }}:latest
            ghcr.io/${{ github.repository }}/${{ matrix.component }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Integration Tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-rust]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Docker Compose
        run: |
          docker-compose --version
      
      - name: Run Integration Tests
        run: |
          # Start all services
          docker-compose up -d
          sleep 30
          
          # Run integration tests (to be implemented)
          # ./scripts/run-integration-tests.sh
          
          # Cleanup
          docker-compose down -v

  # Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [docker, integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Generate Changelog
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 2>/dev/null || echo "")..HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false
