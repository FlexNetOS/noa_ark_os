name: Duplicate Fence
on: [pull_request]
jobs:
  no-dupes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Detect duplicate files by SHA-256
        shell: bash
        run: |
          set -euo pipefail
          base=origin/${{ github.base_ref }}
          python3 - << 'PY'
import hashlib, os, sys, subprocess
ALLOW_PREFIXES = ("archive/", "out/", ".git/", ".next/", "target/", "node_modules/", "dist/", "build/")
base = os.environ.get('GITHUB_BASE_REF')
if not base:
    print('Skipping duplicate file check: GITHUB_BASE_REF is missing. This usually means the workflow is not running in a pull request context or the environment is misconfigured.', file=sys.stderr)
    sys.exit(0)
changed = subprocess.run(["bash","-lc",f"git diff --name-only origin/{base}..."], capture_output=True, text=True).stdout.split()
seen = {}
violations = []
for p in changed:
    if any(p.startswith(a) for a in ALLOW_PREFIXES):
        continue
    if not os.path.isfile(p):
        continue
    with open(p,'rb') as f:
        hasher = hashlib.sha256()
        while True:
            chunk = f.read(1024 * 1024)
            if not chunk:
                break
            hasher.update(chunk)
        h = hasher.hexdigest()
    if h in seen and seen[h] != p:
        violations.append((p, seen[h], h))
    else:
        seen[h] = p
if violations:
    print('Duplicate content detected:', file=sys.stderr)
    for a,b,h in violations:
        print(f"  {a} == {b} ({h})", file=sys.stderr)
    sys.exit(1)
PY