name: CRC

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - 'crc/**'
      - 'crc-adapter-sdk/**'
      - 'policies/crc/**'
      - 'registry/**'

jobs:
  crc:
    runs-on: ubuntu-latest
    env:
      OFFLINE_FIRST: "true"
      AI_PROVIDER: llama.cpp
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            .
      - name: Build CRC
        run: cargo build -p noa_crc
      - name: Run CRC smoke tests
        run: cargo test -p noa_crc --test cas_smoke --test digest_smoke --test dag_seed
      - name: Run CRC tests
        run: cargo test -p noa_crc
      - name: Run Adapter SDK tests
        run: cargo test -p crc_adapter_sdk
      - name: Generate CRC ingest report
        run: cargo run -p noa_crc -- ingest --root . --report out/ci/ingest.json
      - name: Archive artifacts
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: crc-artifacts
          path: out/ci
