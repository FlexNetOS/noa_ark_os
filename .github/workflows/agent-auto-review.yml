name: Agent Auto Review
on:
  pull_request:
    branches: [ main, develop ]

jobs:
  agent-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.4
          run_install: false

      - name: Install minimal deps
        run: pnpm install --frozen-lockfile --filter vibe-kanban --filter .

      - name: Generate Health Snapshot
        env:
          HEALTH_MAX_UPTIME_SECONDS: 10
          CI_FAST_HEALTH_TIMEOUT_SECONDS: 90
          CI_FAST_HEALTH_PROBE_DELAY_SECONDS: 5
        run: make ci-fast-health

      - name: Agent Semantic Drift Scan
        run: cargo run -p noa_tools_agent --bin agent-tools Semantic --query "DRIFT" --root . | head -n 100 || true

      - name: Agent Capability Consolidation Index
        run: cargo run -p noa_tools_agent --bin agent-tools Grep --pattern "Capability:" --root . | head -n 60 || true

      - name: Upload readiness artifact
        uses: actions/upload-artifact@v4
        with:
          name: readiness-agent-review
          path: logs/readiness.json

      - name: Emit Review Summary
        run: |
          echo "RESULT: PASS"
          echo "WHY: Automated agent review executed; health gate passed"
          echo "EVIDENCE: readiness.json + semantic drift scan"
          echo "NEXT: merge if other CI gates pass"
