name: Deletion Lock
on: [pull_request]
jobs:
  lock:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Fail on deletion/rename without archive proof
        shell: bash
        run: |
          set -euo pipefail
          base=origin/${{ github.base_ref }}
          git diff --name-status "$base"... | tee diff.txt
          if grep -E '^(D|R[0-9]+)\s' diff.txt >/dev/null; then
            changed=$(git diff --name-only "$base"...)
            echo "$changed" | grep -q '^archive/' || { echo "Deletion/rename found but no archive/ artifacts present." >&2; exit 1; }
            echo "$changed" | grep -q '^docs/verification/' || { echo "Deletion/rename found but no evidence ledger update under docs/verification/." >&2; exit 1; }
          fi