<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NOA ARK OS – Unified Control Plane</title>
    <style>
        :root {
            color-scheme: dark;
            --bg-gradient: linear-gradient(135deg, #1a1c2e 0%, #251d3a 100%);
            --card-bg: rgba(32, 35, 58, 0.8);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #38bdf8;
            --accent-strong: #0ea5e9;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 24px;
            background: var(--bg-gradient);
            color: #f3f4f6;
        }

        a {
            color: inherit;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        header {
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.65);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
        }

        header h1 {
            font-size: clamp(2rem, 4vw, 3rem);
            margin: 0;
        }

        header p {
            margin: 0;
            max-width: 60ch;
            color: rgba(226, 232, 240, 0.8);
        }

        .badge-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(14, 165, 233, 0.15);
            border: 1px solid rgba(14, 165, 233, 0.25);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            backdrop-filter: blur(12px);
        }

        .card h2 {
            font-size: 1.1rem;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            color: rgba(226, 232, 240, 0.85);
        }

        .metric strong {
            color: #f8fafc;
        }

        section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section-heading {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .two-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        th {
            color: rgba(226, 232, 240, 0.7);
            font-weight: 600;
        }

        tbody tr:hover {
            background: rgba(148, 163, 184, 0.08);
        }

        button {
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: #0f172a;
            font-weight: 600;
            padding: 8px 16px;
            cursor: pointer;
            transition: transform 0.1s ease, background 0.2s ease;
        }

        button:hover {
            background: var(--accent-strong);
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        input[type="number"],
        textarea {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(15, 23, 42, 0.75);
            color: inherit;
            padding: 10px 12px;
            font-size: 1rem;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .chat-panel {
            display: grid;
            gap: 12px;
        }

        .chat-output {
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(15, 23, 42, 0.75);
            min-height: 120px;
            padding: 12px 14px;
            font-family: "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", monospace;
            white-space: pre-wrap;
        }

        .event-log {
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(15, 23, 42, 0.65);
            padding: 12px;
            max-height: 240px;
            overflow-y: auto;
            font-size: 0.9rem;
            display: grid;
            gap: 8px;
        }

        .event-log .event {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(56, 189, 248, 0.08);
            border: 1px solid rgba(56, 189, 248, 0.15);
        }

        .event-type {
            font-weight: 600;
            color: var(--accent);
        }

        .muted {
            color: rgba(226, 232, 240, 0.65);
            font-size: 0.9rem;
        }

        .empty {
            color: rgba(148, 163, 184, 0.6);
            text-align: center;
            padding: 12px 0;
        }

        @media (max-width: 720px) {
            body {
                padding: 16px;
            }

            header {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="root" class="container">
    <div class="container">
        <header>
            <div class="badge-row">
                <span class="badge" id="apiStatus">Connecting to API…</span>
                <span class="badge">Unified Shell Preview</span>
            </div>
            <h1>NOA ARK OS Control Plane</h1>
            <p>
                Operate workflows, agents, CI/CD, storage, analytics, and AI chat from a single surface.
                Every interaction below talks directly to the unified FastAPI gateway.
            </p>
        </header>

        <section>
            <div class="grid">
                <article class="card">
                    <h2>Analytics Spotlight <span id="roiValue" class="muted">—</span></h2>
                    <div id="analyticsMetrics" class="metric-list"></div>
                </article>
                <article class="card">
                    <h2>Recent Workflow Runs</h2>
                    <div id="workflowRuns" class="metric-list"></div>
                </article>
                <article class="card">
                    <h2>Live Events</h2>
                    <div id="eventLog" class="event-log">
                        <div class="empty">Listening for events…</div>
                    </div>
                </article>
            </div>
        </section>

        <section>
            <div class="section-heading">Workflow Command Center</div>
            <div id="workflowList" class="two-column"></div>
        </section>

        <section class="two-column">
            <article class="card">
                <h2>Agent Hive</h2>
                <div class="muted">Scale agent families and monitor load.</div>
                <div id="agentTable"></div>
            </article>
            <article class="card">
                <h2>CI Pipelines</h2>
                <div class="muted">Re-run pipelines straight from the dashboard.</div>
                <div id="pipelineTable"></div>
            </article>
        </section>

        <section class="two-column">
            <article class="card">
                <h2>Storage &amp; Artifacts</h2>
                <div id="artifactTable"></div>
            </article>
            <article class="card chat-panel">
                <h2>AI Co-Developer Chat</h2>
                <textarea id="chatInput" placeholder="Ask NOA to trigger workflows, open modules, or explain capabilities."></textarea>
                <div class="chat-actions">
                    <button id="chatSend">Send Message</button>
                </div>
                <div id="chatOutput" class="chat-output">Awaiting command…</div>
            </article>
        </section>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const DEFAULT_API_URL = 'http://localhost:8000';
        const API_URL = params.get('api') || DEFAULT_API_URL;

        const API_STATUS = document.getElementById('apiStatus');
        const METRICS_CONTAINER = document.getElementById('analyticsMetrics');
        const ROI_VALUE = document.getElementById('roiValue');
        const WORKFLOW_LIST = document.getElementById('workflowList');
        const WORKFLOW_RUNS = document.getElementById('workflowRuns');
        const AGENT_TABLE = document.getElementById('agentTable');
        const PIPELINE_TABLE = document.getElementById('pipelineTable');
        const ARTIFACT_TABLE = document.getElementById('artifactTable');
        const CHAT_INPUT = document.getElementById('chatInput');
        const CHAT_OUTPUT = document.getElementById('chatOutput');
        const EVENT_LOG = document.getElementById('eventLog');

        let eventSocket;

        function formatDate(dateString) {
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) {
                return dateString;
            }
            return date.toLocaleString();
        }

        function updateBadge(status, message) {
            API_STATUS.textContent = message;
            API_STATUS.style.background = status === 'ok' ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)';
            API_STATUS.style.border = status === 'ok' ? '1px solid rgba(34,197,94,0.4)' : '1px solid rgba(239,68,68,0.4)';
        }

        async function fetchJson(url, options) {
            const response = await fetch(url, options);
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`${response.status}: ${text}`);
            }
            return response.json();
        }

        function renderMetrics(metrics) {
            METRICS_CONTAINER.innerHTML = '';
            if (!metrics.length) {
                METRICS_CONTAINER.innerHTML = '<div class="empty">No analytics metrics available.</div>';
                return;
            }
            for (const metric of metrics) {
                const div = document.createElement('div');
                div.className = 'metric';
                div.innerHTML = `<span>${metric.label}</span><strong>${metric.value} ${metric.unit}</strong>`;
                METRICS_CONTAINER.appendChild(div);
            }
        }

        function renderWorkflowRuns(runs) {
            WORKFLOW_RUNS.innerHTML = '';
            if (!runs.length) {
                WORKFLOW_RUNS.innerHTML = '<div class="empty">No workflow runs yet.</div>';
                return;
            }
            runs.slice(0, 4).forEach((run) => {
                const div = document.createElement('div');
                div.className = 'metric';
                div.innerHTML = `<span>${run.workflow_id}</span><strong>${run.status}</strong><span class="muted">${formatDate(run.triggered_at)}</span>`;
                WORKFLOW_RUNS.appendChild(div);
            });
        }

        function renderWorkflows(workflows) {
            WORKFLOW_LIST.innerHTML = '';
            if (!workflows.length) {
                WORKFLOW_LIST.innerHTML = '<div class="card">No workflows registered.</div>';
                return;
            }
            for (const workflow of workflows) {
                const card = document.createElement('article');
                card.className = 'card';
                const stages = workflow.stages.map((stage) => `<li>${stage.label} – ${stage.description}</li>`).join('');
                card.innerHTML = `
                    <h3>${workflow.label}</h3>
                    <p class="muted">${workflow.description}</p>
                    <ul class="muted" style="padding-left: 20px; line-height: 1.6;">
                        ${stages}
                    </ul>
                    <button data-workflow="${workflow.id}">Run Workflow</button>
                `;
                const button = card.querySelector('button');
                button.addEventListener('click', async () => {
                    button.disabled = true;
                    try {
                        await fetchJson(`${API_URL}/api/workflows/${workflow.id}/trigger`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ source: 'dashboard' }),
                        });
                        addEvent({ type: 'workflow_triggered', workflow_id: workflow.id, via: 'dashboard' });
                        await refreshWorkflowRuns();
                    } catch (error) {
                        alert(`Failed to trigger workflow: ${error.message}`);
                    } finally {
                        button.disabled = false;
                    }
                });
                WORKFLOW_LIST.appendChild(card);
            }
        }

        function renderAgents(agents) {
            if (!agents.length) {
                AGENT_TABLE.innerHTML = '<div class="empty">No active agents registered.</div>';
                return;
            }
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr><th>ID</th><th>Role</th><th>Status</th><th>Load</th><th>Scale</th></tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');
            for (const agent of agents) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${agent.id}</td>
                    <td>${agent.role}</td>
                    <td>${agent.status}</td>
                    <td>${(agent.load * 100).toFixed(0)}%</td>
                    <td>
                        <form data-agent="${agent.id}" class="scale-form">
                            <input type="number" min="0" max="32" value="1" aria-label="replicas for ${agent.id}" />
                            <button type="submit">Scale</button>
                        </form>
                    </td>
                `;
                tbody.appendChild(row);
            }
            AGENT_TABLE.innerHTML = '';
            AGENT_TABLE.appendChild(table);
            for (const form of AGENT_TABLE.querySelectorAll('.scale-form')) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const agentId = form.dataset.agent;
                    const input = form.querySelector('input');
                    const replicas = Number.parseInt(input.value, 10);
                    if (Number.isNaN(replicas)) {
                        alert('Enter a replica count.');
                        return;
                    }
                    try {
                        await fetchJson(`${API_URL}/api/agents/${agentId}/scale`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ replicas }),
                        });
                        addEvent({ type: 'agent_scaled', agent_id: agentId, replicas });
                    } catch (error) {
                        alert(`Failed to scale agent: ${error.message}`);
                    }
                });
            }
        }

        function renderPipelines(pipelines) {
            if (!pipelines.length) {
                PIPELINE_TABLE.innerHTML = '<div class="empty">No CI pipelines configured.</div>';
                return;
            }
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr><th>ID</th><th>Branch</th><th>Status</th><th>Last Run</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');
            for (const pipeline of pipelines) {
                const row = document.createElement('tr');
                const statusColour = pipeline.status === 'passing' ? 'var(--success)' : 'var(--danger)';
                row.innerHTML = `
                    <td>${pipeline.id}</td>
                    <td>${pipeline.branch}</td>
                    <td style="color:${statusColour}; font-weight:600;">${pipeline.status}</td>
                    <td>${formatDate(pipeline.last_run)}</td>
                    <td><button data-pipeline="${pipeline.id}">Re-run</button></td>
                `;
                tbody.appendChild(row);
            }
            PIPELINE_TABLE.innerHTML = '';
            PIPELINE_TABLE.appendChild(table);
            for (const button of PIPELINE_TABLE.querySelectorAll('button[data-pipeline]')) {
                button.addEventListener('click', async () => {
                    const pipelineId = button.dataset.pipeline;
                    button.disabled = true;
                    try {
                        await fetchJson(`${API_URL}/api/ci/pipelines/${pipelineId}/rerun`, {
                            method: 'POST',
                        });
                        addEvent({ type: 'ci_rerun', pipeline_id: pipelineId });
                    } catch (error) {
                        alert(`Failed to rerun pipeline: ${error.message}`);
                    } finally {
                        button.disabled = false;
                    }
                });
            }
        }

        function renderArtifacts(artifacts) {
            if (!artifacts.length) {
                ARTIFACT_TABLE.innerHTML = '<div class="empty">No artifacts stored.</div>';
                return;
            }
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr><th>Name</th><th>Size</th><th>Checksum</th><th></th></tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');
            for (const artifact of artifacts) {
                const row = document.createElement('tr');
                const sizeMb = (artifact.size_bytes / (1024 * 1024)).toFixed(2);
                row.innerHTML = `
                    <td>${artifact.name}</td>
                    <td>${sizeMb} MB</td>
                    <td class="muted">${artifact.checksum}</td>
                    <td><button data-artifact="${artifact.id}">Retain</button></td>
                `;
                tbody.appendChild(row);
            }
            ARTIFACT_TABLE.innerHTML = '';
            ARTIFACT_TABLE.appendChild(table);
            for (const button of ARTIFACT_TABLE.querySelectorAll('button[data-artifact]')) {
                button.addEventListener('click', async () => {
                    const artifactId = button.dataset.artifact;
                    button.disabled = true;
                    try {
                        await fetchJson(`${API_URL}/api/storage/artifacts/${artifactId}/retain`, {
                            method: 'POST',
                        });
                        addEvent({ type: 'artifact_retained', artifact_id: artifactId });
                    } catch (error) {
                        alert(`Failed to retain artifact: ${error.message}`);
                    } finally {
                        button.disabled = false;
                    }
                });
            }
        }

        async function refreshWorkflowRuns() {
            try {
                const runs = await fetchJson(`${API_URL}/api/workflows/runs`);
                renderWorkflowRuns(runs);
            } catch (error) {
                console.error('Failed to load workflow runs', error);
            }
        }

        async function loadData() {
            try {
                updateBadge('ok', `Connected to ${API_URL}`);
                const [metrics, roi, workflows, agents, pipelines, artifacts] = await Promise.all([
                    fetchJson(`${API_URL}/api/analytics/metrics`).catch(() => []),
                    fetchJson(`${API_URL}/api/analytics/roi`).catch(() => ({ roi: null })),
                    fetchJson(`${API_URL}/api/workflows/`).catch(() => []),
                    fetchJson(`${API_URL}/api/agents/`).catch(() => []),
                    fetchJson(`${API_URL}/api/ci/pipelines`).catch(() => []),
                    fetchJson(`${API_URL}/api/storage/artifacts`).catch(() => []),
                ]);
                renderMetrics(metrics);
                ROI_VALUE.textContent = roi.roi == null ? '—' : `${roi.roi}x ROI`;
                renderWorkflows(workflows);
                renderAgents(agents);
                renderPipelines(pipelines);
                renderArtifacts(artifacts);
                await refreshWorkflowRuns();
            } catch (error) {
                updateBadge('error', `API unavailable (${error.message})`);
            }
        }

        function addEvent(event) {
            const entry = document.createElement('div');
            entry.className = 'event';
            const timestamp = new Date().toLocaleTimeString();
            const details = JSON.stringify(event, null, 2);
            entry.innerHTML = `<span class="event-type">${event.type || 'event'}</span><span class="muted">${timestamp}</span>`;
            entry.title = details;
            EVENT_LOG.prepend(entry);
            while (EVENT_LOG.children.length > 10) {
                EVENT_LOG.removeChild(EVENT_LOG.lastChild);
            }
            const emptyState = EVENT_LOG.querySelector('.empty');
            if (emptyState) {
                emptyState.remove();
            }
        }

        function connectEvents() {
            const wsUrl = API_URL.replace(/^http/, 'ws') + '/ws/events';
            if (eventSocket) {
                eventSocket.close();
            }
            try {
                eventSocket = new WebSocket(wsUrl);
                eventSocket.onmessage = (message) => {
                    try {
                        const payload = JSON.parse(message.data);
                        addEvent(payload);
                    } catch (error) {
                        console.error('Failed to parse event payload', error);
                    }
                };
                eventSocket.onclose = () => {
                    setTimeout(connectEvents, 4000);
                };
            } catch (error) {
                console.warn('WebSocket unavailable', error);
            }
        }

        async function sendChat() {
            const message = CHAT_INPUT.value.trim();
            if (!message) {
                CHAT_OUTPUT.textContent = 'Enter a prompt to send to the co-developer.';
                return;
            }
            CHAT_OUTPUT.textContent = 'Sending…';
            try {
                const response = await fetchJson(`${API_URL}/api/chat/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message }),
                });
                CHAT_OUTPUT.textContent = response.reply;
                CHAT_INPUT.value = '';
            } catch (error) {
                CHAT_OUTPUT.textContent = `Failed to send message: ${error.message}`;
            }
        }

        document.getElementById('chatSend').addEventListener('click', sendChat);
        CHAT_INPUT.addEventListener('keydown', (event) => {
            if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
                event.preventDefault();
                sendChat();
            }
        });

        loadData();
        connectEvents();
        setInterval(refreshWorkflowRuns, 12000);
    </script>
</body>
</html>
