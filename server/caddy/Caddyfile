###############################
# NOA Ark OS - Production template
#
# This file mirrors the reference configuration captured in
# `server/BUILD_SPEC.md`. Use the overlays/ directory for
# environment-specific additions.
###############################

{
    admin {$NOA_CADDY_ADMIN_ENDPOINT:-0.0.0.0:2019}
    auto_https on
    email {$NOA_CADDY_ACME_EMAIL:-admin@noa-ark-os.com}
    storage file_system {
        root {$NOA_CADDY_STORAGE_ROOT:-data/storage/caddy}
    }
    log {
        level {$NOA_CADDY_LOG_LEVEL:-INFO}
        output file {$NOA_CADDY_APP_LOG:-logs/applications/caddy/app.log} {
            roll_size 50MiB
            roll_keep 5
            roll_keep_for 120d
        }
    }
}

{$NOA_CADDY_PRIMARY_DOMAIN:-noa-ark-os.com} {
    reverse_proxy {$NOA_CADDY_UPSTREAM:-localhost:8080} {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        lb_policy round_robin
        lb_try_duration 5s
        lb_try_interval 250ms
        health_uri {$NOA_CADDY_HEALTH_URI:-/health}
        health_interval 10s
        health_timeout 5s
    }

    @websocket {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    reverse_proxy @websocket {$NOA_CADDY_WS_UPSTREAM:-localhost:8080}

    encode gzip zstd

    rate_limit {
        zone dynamic {
            key {remote_host}
            events {$NOA_CADDY_RATE_EVENTS:-100}
            window {$NOA_CADDY_RATE_WINDOW:-1m}
        }
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Content-Security-Policy "default-src 'self'"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    log {
        output file {$NOA_CADDY_ACCESS_LOG:-logs/applications/caddy/access.log}
        format json
    }
}

:9090 {
    @metrics {
        remote_ip 127.0.0.1 10.0.0.0/8
    }
    handle @metrics {
        reverse_proxy {$NOA_CADDY_METRICS_TARGET:-localhost:9090}
    }
    handle {
        respond "Forbidden" 403
    }
}

api.{$NOA_CADDY_PRIMARY_DOMAIN:-noa-ark-os.com} {
    reverse_proxy {$NOA_CADDY_UPSTREAM:-localhost:8080} {
        header_up Host {host}
    }
}
